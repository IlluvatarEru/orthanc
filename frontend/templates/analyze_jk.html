{% extends "base.html" %}

{% block title %}Analysis - {{ analysis.residential_complex_name }} - Orthanc Capital{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-building"></i> Analysis for {{ analysis.residential_complex_name }}</h2>
                <p class="mb-0 text-muted">
                    Date: {{ analysis.query_date }} | Area limit: ≤{{ analysis.area_max }} m²
                </p>
            </div>
        </div>
    </div>
</div>

{% if analysis.rental_stats and analysis.sales_stats %}
<div class="row mt-4">
    <!-- Rental Statistics -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-home"></i> Rental Statistics ({{ analysis.rental_stats.count }} flats)</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <h6>Price Range</h6>
                        <p class="text-primary">
                            {% if show_eur %}
                                €{{ "{:,}".format(analysis.rental_stats.price_stats.min / 500) }} - €{{ "{:,}".format(analysis.rental_stats.price_stats.max / 500) }}
                            {% else %}
                                ₸{{ "{:,}".format(analysis.rental_stats.price_stats.min) }} - ₸{{ "{:,}".format(analysis.rental_stats.price_stats.max) }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-6">
                        <h6>Average Price</h6>
                        <p class="text-primary">
                            {% if show_eur %}
                                €{{ "{:,.0f}".format(analysis.rental_stats.price_stats.avg / 500) }}
                            {% else %}
                                ₸{{ "{:,.0f}".format(analysis.rental_stats.price_stats.avg) }}
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <h6>Median Price</h6>
                        <p class="text-primary">
                            {% if show_eur %}
                                €{{ "{:,.0f}".format(analysis.rental_stats.price_stats.median / 500) }}
                            {% else %}
                                ₸{{ "{:,.0f}".format(analysis.rental_stats.price_stats.median) }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-6">
                        <h6>Average Area</h6>
                        <p class="text-primary">{{ "{:.1f}".format(analysis.rental_stats.area_stats.avg) }} m²</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Statistics -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-money-bill-wave"></i> Sales Statistics ({{ analysis.sales_stats.count }} flats)</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <h6>Price Range</h6>
                        <p class="text-success">
                            {% if show_eur %}
                                €{{ "{:,}".format(analysis.sales_stats.price_stats.min / 500) }} - €{{ "{:,}".format(analysis.sales_stats.price_stats.max / 500) }}
                            {% else %}
                                ₸{{ "{:,}".format(analysis.sales_stats.price_stats.min) }} - ₸{{ "{:,}".format(analysis.sales_stats.price_stats.max) }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-6">
                        <h6>Average Price</h6>
                        <p class="text-success">
                            {% if show_eur %}
                                €{{ "{:,.0f}".format(analysis.sales_stats.price_stats.avg / 500) }}
                            {% else %}
                                ₸{{ "{:,.0f}".format(analysis.sales_stats.price_stats.avg) }}
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <h6>Median Price</h6>
                        <p class="text-success">
                            {% if show_eur %}
                                €{{ "{:,.0f}".format(analysis.sales_stats.price_stats.median / 500) }}
                            {% else %}
                                ₸{{ "{:,.0f}".format(analysis.sales_stats.price_stats.median) }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-6">
                        <h6>Average Area</h6>
                        <p class="text-success">{{ "{:.1f}".format(analysis.sales_stats.area_stats.avg) }} m²</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rental Yield Analysis -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card stats-card">
            <div class="card-header">
                <h4><i class="fas fa-chart-line"></i> Rental Yield Analysis</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6>Median Annual Rent</h6>
                        <p class="h4">
                            {% if show_eur %}
                                €{{ "{:,.0f}".format(analysis.yield_analysis.median_annual_rent / 500) }}
                            {% else %}
                                ₸{{ "{:,.0f}".format(analysis.yield_analysis.median_annual_rent) }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-3">
                        <h6>Median Sale Price</h6>
                        <p class="h4">
                            {% if show_eur %}
                                €{{ "{:,.0f}".format(analysis.yield_analysis.median_sale_price / 500) }}
                            {% else %}
                                ₸{{ "{:,.0f}".format(analysis.yield_analysis.median_sale_price) }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-3">
                        <h6>Median Yield</h6>
                        <p class="h4 {% if analysis.yield_analysis.median_yield_percent > 8 %}yield-high{% elif analysis.yield_analysis.median_yield_percent > 5 %}yield-medium{% else %}yield-low{% endif %}">
                            {{ "{:.2f}".format(analysis.yield_analysis.median_yield_percent) }}%
                        </p>
                    </div>
                    <div class="col-md-3">
                        <h6>Average Yield</h6>
                        <p class="h4 {% if analysis.yield_analysis.avg_yield_percent > 8 %}yield-high{% elif analysis.yield_analysis.avg_yield_percent > 5 %}yield-medium{% else %}yield-low{% endif %}">
                            {{ "{:.2f}".format(analysis.yield_analysis.avg_yield_percent) }}%
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Market Insights -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-lightbulb"></i> Market Insights</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Rental Price per m²</h6>
                        <p class="text-primary">
                            {% if show_eur %}
                                €{{ "{:,.0f}".format(analysis.insights.price_per_sqm.rental / 500) }}
                            {% else %}
                                ₸{{ "{:,.0f}".format(analysis.insights.price_per_sqm.rental) }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-4">
                        <h6>Sales Price per m²</h6>
                        <p class="text-success">
                            {% if show_eur %}
                                €{{ "{:,.0f}".format(analysis.insights.price_per_sqm.sales / 500) }}
                            {% else %}
                                ₸{{ "{:,.0f}".format(analysis.insights.price_per_sqm.sales) }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-4">
                        <h6>Investment Potential</h6>
                        <p class="{% if analysis.insights.market_position.investment_potential == 'High' %}text-success{% elif analysis.insights.market_position.investment_potential == 'Medium' %}text-warning{% else %}text-danger{% endif %}">
                            {{ analysis.insights.market_position.investment_potential }}
                        </p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <h6>Data Reliability</h6>
                        <p class="{% if analysis.insights.data_quality.reliability == 'High' %}text-success{% elif analysis.insights.data_quality.reliability == 'Medium' %}text-warning{% else %}text-danger{% endif %}">
                            {{ analysis.insights.data_quality.reliability }}
                        </p>
                    </div>
                    <div class="col-md-4">
                        <h6>Rental Sample Size</h6>
                        <p>{{ analysis.insights.data_quality.rental_sample_size }} flats</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Sales Sample Size</h6>
                        <p>{{ analysis.insights.data_quality.sales_sample_size }} flats</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Yield Distribution by Bucket -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-chart-bar"></i> Yield Distribution by Bucket</h4>
            </div>
            <div class="card-body">
                <div style="height: 400px; position: relative;">
                    <canvas id="yieldDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> 
            Insufficient data for analysis. 
            {% if not analysis.rental_stats %}No rental data found.{% endif %}
            {% if not analysis.sales_stats %}No sales data found.{% endif %}
        </div>
    </div>
</div>
{% endif %}

<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex gap-2">
            <a href="{{ url_for('search_jk') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Search
            </a>
            <a href="{{ url_for('view_jk_flats', residential_complex_name=analysis.residential_complex_name) }}" class="btn btn-primary">
                <i class="fas fa-list"></i> View All Flats
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if box plot plugin is available
    if (!Chart.controllers || !Chart.controllers.boxplot) {
        console.error('Box plot plugin not loaded!');
        console.log('Available controllers:', Object.keys(Chart.controllers || {}));
        document.getElementById('yieldDistributionChart').parentElement.innerHTML = 
            '<p class="text-danger text-center">Box plot plugin not loaded. Please refresh the page.</p>';
        return;
    }
    
    console.log('Box plot plugin is available!');
    
    // Get actual yield data from bucket analysis
    const bucketData = {{ bucket_analysis.bucket_analysis | tojson | safe if bucket_analysis and bucket_analysis.bucket_analysis else '[]' }};
    
    console.log('Bucket data:', bucketData);
    
    // Transform bucket data for box plot
    const chartData = bucketData
        .filter(bucket => bucket.rental_count > 0 && bucket.sales_count > 0 && bucket.yields && bucket.yields.length > 0)
        .map(bucket => ({
            label: `${bucket.rooms}BR ${bucket.area_bucket}`,
            data: bucket.yields
        }));
    
    console.log('Chart data:', chartData);
    
    // Box plot data configuration using real yield data
    const data = {
        labels: chartData.map(item => item.label),
        datasets: [
            {
                label: 'Yield Distribution',
                data: chartData.map(item => item.data),
            },
        ],
    };

    const config = {
        type: 'boxplot',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Yield Distribution by Bucket',
                    color: 'white'
                },
                legend: {
                    display: true,
                    labels: {
                        color: 'white'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Yield (%)',
                        color: 'white'
                    },
                    ticks: {
                        color: 'white'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Bucket',
                        color: 'white'
                    },
                    ticks: {
                        color: 'white',
                        maxRotation: 45,
                        minRotation: 0
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    };

    // Create the box plot chart
    const ctx = document.getElementById('yieldDistributionChart');
    if (ctx) {
        try {
            console.log('Creating box plot with config:', config);
            console.log('Chart.js version:', Chart.version);
            console.log('Available chart types:', Object.keys(Chart.controllers || {}));
            
            const chart = new Chart(ctx, config);
            console.log('Box plot chart created successfully!');
            console.log('Chart instance:', chart);
        } catch (error) {
            console.error('Error creating box plot chart:', error);
            console.error('Error stack:', error.stack);
            ctx.parentElement.innerHTML = '<p class="text-danger text-center">Error creating box plot: ' + error.message + '</p>';
        }
    } else {
        console.error('Canvas element not found');
    }
});
</script>
{% endblock %} 