{% extends "base.html" %}

{% block title %}Estimation Results - Orthanc Capital{% endblock %}

{% block extra_css %}
<style>
    /* Override KPI card font sizes for estimate results */
    .estimate-kpi .kpi-value {
        font-size: 1.5rem !important;
        font-weight: 600 !important;
    }
    
    .estimate-kpi .kpi-label {
        font-size: 0.85rem !important;
        font-weight: 500 !important;
    }
    
    /* Make price values slightly bigger but not huge */
    .estimate-kpi .price-kzt {
        font-size: 1.2em !important;
        font-weight: 600 !important;
    }
    
    /* Smaller cards for better fit */
    .estimate-kpi {
        padding: 1rem !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-1">Flat Analysis Results</h1>
                <p class="text-muted mb-0">Area tolerance: ¬±{{ area_tolerance }}%</p>
            </div>
        </div>
    </div>
</div>

<!-- Flat Details -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-info-circle me-2"></i>Flat Details</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-primary">
                                {% if show_eur %}
                                    ‚Ç¨{{ "{:,.0f}".format((flat_info.price or 0) / eur_rate) }}
                                {% else %}
                                    ‚Ç∏{{ "{:,}".format(flat_info.price or 0) }}
                                {% endif %}
                            </div>
                            <div class="kpi-label">Price</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-success">{{ "{:.1f}".format(flat_info.area or 0) }} m¬≤</div>
                            <div class="kpi-label">Area</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-warning">{{ flat_info.residential_complex or 'N/A' }}</div>
                            <div class="kpi-label">Residential Complex</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-info">{{ flat_info.floor or 'N/A' }}</div>
                            <div class="kpi-label">Floor</div>
                        </div>
                    </div>
                </div>
                {% if flat_info.construction_year %}
                <div class="row mt-3">
                    <div class="col-md-3">
                        <h6>Construction Year</h6>
                        <p class="text-muted">{{ flat_info.construction_year }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Description</h6>
                        <p class="text-muted">{{ flat_info.description[:200] }}{% if flat_info.description|length > 200 %}...{% endif %}</p>
                    </div>
                    <div class="col-md-3">
                        <h6>Actions</h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-warning btn-sm toggle-favorite" 
                                    data-flat-id="{{ flat_info.flat_id or '' }}" 
                                    data-flat-type="sale"
                                    data-price="{{ flat_info.price or 0 }}"
                                    data-area="{{ flat_info.area or 0 }}"
                                    data-residential-complex="{{ flat_info.residential_complex or '' }}"
                                    data-floor="{{ flat_info.floor or '' }}"
                                    data-total-floors="{{ flat_info.total_floors or '' }}"
                                    data-construction-year="{{ flat_info.construction_year or '' }}"
                                    data-parking="{{ flat_info.parking or '' }}"
                                    data-description="{{ flat_info.description or '' }}"
                                    data-url="https://krisha.kz/a/show/{{ flat_info.flat_id or '' }}">
                                <i class="fas fa-heart"></i>
                            </button>
                            <a href="https://krisha.kz/a/show/{{ flat_info.flat_id }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-external-link-alt me-1"></i>View on Krisha
                            </a>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="row mt-3">
                    <div class="col-md-9">
                        <h6>Description</h6>
                        <p class="text-muted">{{ flat_info.description[:200] }}{% if flat_info.description|length > 200 %}...{% endif %}</p>
                    </div>
                    <div class="col-md-3">
                        <h6>Actions</h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-warning btn-sm toggle-favorite" 
                                    data-flat-id="{{ flat_info.flat_id or '' }}" 
                                    data-flat-type="sale"
                                    data-price="{{ flat_info.price or 0 }}"
                                    data-area="{{ flat_info.area or 0 }}"
                                    data-residential-complex="{{ flat_info.residential_complex or '' }}"
                                    data-floor="{{ flat_info.floor or '' }}"
                                    data-total-floors="{{ flat_info.total_floors or '' }}"
                                    data-construction-year="{{ flat_info.construction_year or '' }}"
                                    data-parking="{{ flat_info.parking or '' }}"
                                    data-description="{{ flat_info.description or '' }}"
                                    data-url="https://krisha.kz/a/show/{{ flat_info.flat_id or '' }}">
                                <i class="fas fa-heart"></i>
                            </button>
                            <a href="https://krisha.kz/a/show/{{ flat_info.flat_id }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-external-link-alt me-1"></i>View on Krisha
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if rental_stats and sales_stats %}
<!-- Similar Properties -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-home me-2"></i>Similar Rental Flats ({{ rental_stats.count }} found)</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-primary">
                                {% if show_eur %}
                                    ‚Ç¨{{ "{:,.0f}".format(rental_stats_fmt.min_price / eur_rate) }}
                                {% else %}
                                    ‚Ç∏{{ "{:,}".format(rental_stats_fmt.min_price) }}
                                {% endif %}
                            </div>
                            <div class="kpi-label">Min Price</div>
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-primary">
                                {% if show_eur %}
                                    ‚Ç¨{{ "{:,.0f}".format(rental_stats_fmt.max_price / eur_rate) }}
                                {% else %}
                                    ‚Ç∏{{ "{:,}".format(rental_stats_fmt.max_price) }}
                                {% endif %}
                            </div>
                            <div class="kpi-label">Max Price</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-success">
                                {% if show_eur %}
                                    ‚Ç¨{{ "{:,.0f}".format(rental_stats_fmt.avg_price / eur_rate) }}
                                {% else %}
                                    ‚Ç∏{{ "{:,}".format(rental_stats_fmt.avg_price) }}
                                {% endif %}
                            </div>
                            <div class="kpi-label">Average Price</div>
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-warning">
                                {% if show_eur %}
                                    ‚Ç¨{{ "{:,.0f}".format(rental_stats_fmt.median_price / eur_rate) }}
                                {% else %}
                                    ‚Ç∏{{ "{:,}".format(rental_stats_fmt.median_price) }}
                                {% endif %}
                            </div>
                            <div class="kpi-label">Median Price</div>
                        </div>
                    </div>
                </div>
                {% if flat_info.residential_complex %}
                <div class="text-center mt-3">
                    <a href="/similar_flats/rental/{{ flat_info.residential_complex }}" 
                       class="btn btn-outline-primary">
                        <i class="fas fa-eye me-1"></i>View All Rental Flats
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Similar Sales Flats ({{ sales_stats.count }} found)</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-success">
                                {% if show_eur %}
                                    ‚Ç¨{{ "{:,.0f}".format(sales_stats_fmt.min_price / eur_rate) }}
                                {% else %}
                                    ‚Ç∏{{ "{:,}".format(sales_stats_fmt.min_price) }}
                                {% endif %}
                            </div>
                            <div class="kpi-label">Min Price</div>
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-success">
                                {% if show_eur %}
                                    ‚Ç¨{{ "{:,.0f}".format(sales_stats_fmt.max_price / eur_rate) }}
                                {% else %}
                                    ‚Ç∏{{ "{:,}".format(sales_stats_fmt.max_price) }}
                                {% endif %}
                            </div>
                            <div class="kpi-label">Max Price</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-warning">
                                {% if show_eur %}
                                    ‚Ç¨{{ "{:,.0f}".format(sales_stats_fmt.avg_price / eur_rate) }}
                                {% else %}
                                    ‚Ç∏{{ "{:,}".format(sales_stats_fmt.avg_price) }}
                                {% endif %}
                            </div>
                            <div class="kpi-label">Average Price</div>
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-info">
                                {% if show_eur %}
                                    ‚Ç¨{{ "{:,.0f}".format(sales_stats_fmt.median_price / eur_rate) }}
                                {% else %}
                                    ‚Ç∏{{ "{:,}".format(sales_stats_fmt.median_price) }}
                                {% endif %}
                            </div>
                            <div class="kpi-label">Median Price</div>
                        </div>
                    </div>
                </div>
                {% if flat_info.residential_complex %}
                <div class="text-center mt-3">
                    <a href="/similar_flats/sales/{{ flat_info.residential_complex }}" 
                       class="btn btn-outline-success">
                        <i class="fas fa-eye me-1"></i>View All Sales Flats
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Investment Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card stats-card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-chart-line me-2"></i>Investment Analysis</h4>
            </div>
            <div class="card-body">
                {% if investment_analysis.insufficient_data %}
                <!-- Insufficient Data Warning -->
                <div class="alert alert-warning" role="alert">
                    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Limited Data Available</h5>
                    <p class="mb-0">{{ investment_analysis.message }}</p>
                    <hr>
                    <p class="mb-0">
                        <strong>Recommendation:</strong> {{ investment_analysis.recommendation }}
                    </p>
                    <p class="mb-0 mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            To get a complete investment analysis, we need both rental and sales data for similar flats in this area.
                            Consider expanding your search area or waiting for more data to become available.
                        </small>
                    </p>
                </div>
                {% else %}
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value text-primary">
                                {% if show_eur %}
                                    ‚Ç¨{{ "{:,.0f}".format((investment_analysis.annual_rental_income or 0) / eur_rate) }}
                                {% else %}
                                    ‚Ç∏{{ "{:,.0f}".format(investment_analysis.annual_rental_income or 0) }}
                                {% endif %}
                            </div>
                            <div class="kpi-label">Expected Annual Rent</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value {% if investment_analysis.rental_yield > 20 %}yield-high{% elif investment_analysis.rental_yield > 8 %}yield-medium{% else %}yield-low{% endif %}">
                                {{ "{:.2f}".format(investment_analysis.rental_yield or 0) }}%
                            </div>
                            <div class="kpi-label">Rental Yield</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value {% if investment_analysis.price_vs_median < -5 %}price-good{% elif investment_analysis.price_vs_median < 5 %}price-fair{% else %}price-high{% endif %}">
                                {{ "{:+.1f}".format(investment_analysis.price_vs_median or 0) }}%
                            </div>
                            <div class="kpi-label">Price vs Median</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="kpi-card estimate-kpi">
                            <div class="kpi-value">
                                {% if investment_analysis.rental_yield > 20 %}
                                    <span class="text-success">üöÄ STRONG BUY</span>
                                {% elif investment_analysis.rental_yield > 8 and investment_analysis.price_vs_median < 0 %}
                                    <span class="text-success">‚úÖ BUY</span>
                                {% elif investment_analysis.rental_yield > 5 %}
                                    <span class="text-warning">‚öñÔ∏è CONSIDER</span>
                                {% else %}
                                    <span class="text-danger">‚ùå PASS</span>
                                {% endif %}
                            </div>
                            <div class="kpi-label">Recommendation</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                {% endif %}

<!-- Discount Scenarios -->
{% if not investment_analysis.insufficient_data %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-percentage me-2"></i>Discount Scenarios</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for scenario in investment_analysis.discount_scenarios %}
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">{{ scenario.discount }}% Discount Scenario</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 col-sm-6 mb-3">
                                        <div class="kpi-card estimate-kpi">
                                            <div class="kpi-value text-primary">
                                                {% if show_eur %}
                                                    ‚Ç¨{{ "{:,.0f}".format((scenario.discounted_price or 0) / eur_rate) }}
                                                {% else %}
                                                    ‚Ç∏{{ "{:,.0f}".format(scenario.discounted_price or 0) }}
                                                {% endif %}
                                            </div>
                                            <div class="kpi-label">Discounted Price</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-sm-6 mb-3">
                                        <div class="kpi-card estimate-kpi">
                                            <div class="kpi-value text-success">
                                                {% if show_eur %}
                                                    ‚Ç¨{{ "{:,.0f}".format((scenario.savings or 0) / eur_rate) }}
                                                {% else %}
                                                    ‚Ç∏{{ "{:,.0f}".format(scenario.savings or 0) }}
                                                {% endif %}
                                            </div>
                                            <div class="kpi-label">Savings</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 col-sm-6 mb-3">
                                        <div class="kpi-card estimate-kpi">
                                            <div class="kpi-value {% if scenario.yield_rate > 15 %}yield-high{% elif scenario.yield_rate > 10 %}yield-medium{% else %}yield-low{% endif %}">
                                                {{ "{:.2f}".format(scenario.yield_rate or 0) }}%
                                            </div>
                                            <div class="kpi-label">Rental Yield</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-sm-6 mb-3">
                                        <div class="kpi-card estimate-kpi">
                                            <div class="kpi-value {% if scenario.price_vs_median < -10 %}price-good{% elif scenario.price_vs_median < -5 %}price-fair{% else %}price-high{% endif %}">
                                                {{ "{:+.1f}".format(scenario.price_vs_median or 0) }}%
                                            </div>
                                            <div class="kpi-label">Price vs Median</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center mt-3">
                                    <p class="mb-0">
                                        {% if scenario.yield_rate > 15 and scenario.price_vs_median < -10 %}
                                            <span class="text-success">üöÄ STRONG BUY with {{ scenario.discount }}% discount</span>
                                        {% elif scenario.yield_rate > 10 and scenario.price_vs_median < -5 %}
                                            <span class="text-success">‚úÖ BUY with {{ scenario.discount }}% discount</span>
                                        {% elif scenario.yield_rate > 6 %}
                                            <span class="text-warning">‚öñÔ∏è CONSIDER with {{ scenario.discount }}% discount</span>
                                        {% else %}
                                            <span class="text-danger">‚ùå PASS even with {{ scenario.discount }}% discount</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% else %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i> 
            Insufficient data for analysis. 
            {% if not rental_stats %}No similar rental data found.{% endif %}
            {% if not sales_stats %}No similar sales data found.{% endif %}
        </div>
    </div>
</div>
{% endif %}

<div class="row mt-4">
    <div class="col-12">
        <a href="/estimate_flat" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Estimation
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Favorite functionality
    const favoriteButtons = document.querySelectorAll('.toggle-favorite');
    
    favoriteButtons.forEach(function(button) {
        // Check initial favorite status
        const flatId = button.getAttribute('data-flat-id');
        const flatType = button.getAttribute('data-flat-type');
        
        console.log('Button data attributes:', {
            flatId: button.getAttribute('data-flat-id'),
            flatType: button.getAttribute('data-flat-type'),
            price: button.getAttribute('data-price'),
            area: button.getAttribute('data-area'),
            residentialComplex: button.getAttribute('data-residential-complex')
        });
        
        console.log('Checking initial favorite status for:', { flatId, flatType });
        
        // Skip if flatId is empty
        if (!flatId || flatId.trim() === '') {
            console.error('Flat ID is empty, skipping favorite check');
            return;
        }
        
        fetch('/api/favorites/check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                flat_id: flatId,
                flat_type: flatType
            })
        })
        .then(response => {
            console.log('Check status response:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Check status data:', data);
            if (data.is_favorite) {
                button.classList.add('btn-warning');
                button.classList.remove('btn-outline-warning');
                console.log('Flat is already in favorites');
            } else {
                console.log('Flat is not in favorites');
            }
        })
        .catch(error => {
            console.error('Error checking favorite status:', error);
        });
        
        // Handle click events
        button.addEventListener('click', function() {
            const flatId = this.getAttribute('data-flat-id');
            const flatType = this.getAttribute('data-flat-type');
            const isFavorite = this.classList.contains('btn-warning');
            
            console.log('Favorite button clicked:', { flatId, flatType, isFavorite });
            
            // Skip if flatId is empty
            if (!flatId || flatId.trim() === '') {
                console.error('Flat ID is empty, cannot add to favorites');
                alert('Error: Flat ID is missing. Cannot add to favorites.');
                return;
            }
            
            const flatData = {
                flat_id: flatId,
                price: parseInt(this.getAttribute('data-price')) || 0,
                area: parseFloat(this.getAttribute('data-area')) || 0,
                residential_complex: this.getAttribute('data-residential-complex') || '',
                floor: this.getAttribute('data-floor') || null,
                total_floors: this.getAttribute('data-total-floors') || null,
                construction_year: this.getAttribute('data-construction-year') || null,
                parking: this.getAttribute('data-parking') || '',
                description: this.getAttribute('data-description') || '',
                url: this.getAttribute('data-url') || `https://krisha.kz/a/show/${flatId}`
            };
            
            console.log('Flat data to send:', flatData);
            
            const url = isFavorite ? '/api/favorites/remove' : '/api/favorites/add';
            const requestBody = isFavorite ? 
                { flat_id: flatId, flat_type: flatType } :
                { flat_id: flatId, flat_type: flatType, flat_data: flatData };
            
            console.log('Sending request to:', url, requestBody);
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    if (isFavorite) {
                        this.classList.remove('btn-warning');
                        this.classList.add('btn-outline-warning');
                    } else {
                        this.classList.add('btn-warning');
                        this.classList.remove('btn-outline-warning');
                    }
                    console.log('Successfully updated favorite status');
                } else {
                    console.error('API Error:', data.error);
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Network Error:', error);
                alert('Network error: ' + error.message);
            });
        });
    });
});
</script>
{% endblock %} 