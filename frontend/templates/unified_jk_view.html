{% extends "base.html" %}

{% block title %}‚ôñ {{ complex_info.name }} - Analysis & Flats - Orthanc Capital{% endblock %}

{% block content %}
<!-- Complex Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                    <div>
                        <h2 class="mb-1"><i class="fas fa-building me-2"></i>{{ complex_info.name }}</h2>
                        {% if complex_info.city %}
                            <p class="mb-0 text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ complex_info.city }}
                                {% if complex_info.district %}, {{ complex_info.district }}{% endif %}
                            </p>
                        {% endif %}
                        <p class="mb-0 text-muted">
                            Date: {{ analysis.query_date }} | Area limit: ‚â§{{ analysis.area_max }} m¬≤
                        </p>
                        <p class="mb-0 text-muted small">
                            <i class="fas fa-database me-1"></i>
                            {% if analysis.rental_stats.count > 0 or analysis.sales_stats.count > 0 %}
                                Data from database | {{ analysis.rental_stats.count + analysis.sales_stats.count }} flats analyzed
                            {% endif %}
                        </p>
                    </div>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <div class="d-flex gap-2 align-items-center">
                            <div class="d-flex flex-column">
                                <label for="area_tolerance" class="form-label mb-0 text-white" style="font-size: 0.85rem;">Area Tol. (%)</label>
                                <input type="number" id="area_tolerance" name="area_tolerance"
                                       class="form-control form-control-sm"
                                       min="1" max="100" value="{{ area_tolerance }}"
                                       style="width: 70px; max-width: 80px;">
                            </div>
                            <div class="d-flex flex-column">
                                <label for="discount_percentage" class="form-label mb-0 text-white" style="font-size: 0.85rem;">Disc. (%)</label>
                                <input type="number" id="discount_percentage" name="discount_percentage"
                                       class="form-control form-control-sm"
                                       min="1" max="100" value="{{ discount_percentage }}"
                                       style="width: 70px; max-width: 80px;">
                            </div>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <button id="refreshAnalysisBtn" class="btn btn-sm btn-primary" onclick="showRefreshConfirm();">
                                <i class="fas fa-sync-alt me-1"></i>Refresh
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="blacklistJK('{{ complex_info.name }}')">
                                <i class="fas fa-ban me-1"></i>Blacklist
                            </button>
                            <a href="{{ url_for('search_jk') }}" class="btn btn-sm btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Back
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Message Display -->
<div id="successMessage" class="alert alert-success alert-dismissible fade" style="display: none;" role="alert">
    <i class="fas fa-check-circle me-2"></i>
    <span id="successMessageText"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>



<!-- Data Quality Warnings -->

<!-- Global Statistics Section - Moved to First Position -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header" style="cursor: pointer;" onclick="toggleSection('global-stats')">
                <h4><i class="fas fa-chevron-down me-2" id="global-stats-icon"></i>Global Statistics</h4>
                <p class="mb-0 text-muted">Overview of rental and sales flats</p>
            </div>
            <div class="card-body collapse show" id="global-stats-content">
                <div class="row">
                    <!-- Sales Global Stats -->
                    <div class="col-md-6">
                        <h5 class="text-success"><i class="fas fa-money-bill-wave me-1"></i>Sales Flats ({{ analysis.sales_stats.count }})</h5>
                        {% if analysis.sales_stats.count > 0 %}
                            <div class="row mb-3">
                                <div class="col-6">
                                    <h6 class="text-muted">Min Price</h6>
                                    <p class="text-white h5">
                                        {% if show_eur %}
                                            ‚Ç¨{{ "{:,.0f}".format((analysis.sales_stats.price_stats.min / eur_rate)|int) }}
                                        {% else %}
                                            ‚Ç∏{{ "{:,}".format(analysis.sales_stats.price_stats.min|int) }}
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-6">
                                    <h6 class="text-muted">Max Price</h6>
                                    <p class="text-white h5">
                                        {% if show_eur %}
                                            ‚Ç¨{{ "{:,.0f}".format((analysis.sales_stats.price_stats.max / eur_rate)|int) }}
                                        {% else %}
                                            ‚Ç∏{{ "{:,}".format(analysis.sales_stats.price_stats.max|int) }}
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-6">
                                    <h6 class="text-muted">Mean Price</h6>
                                    <p class="text-white h5">
                                        {% if show_eur %}
                                            ‚Ç¨{{ "{:,.0f}".format((analysis.sales_stats.price_stats.avg / eur_rate)|int) }}
                                        {% else %}
                                            ‚Ç∏{{ "{:,}".format(analysis.sales_stats.price_stats.avg|int) }}
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-6">
                                    <h6 class="text-muted">Median Price</h6>
                                    <p class="text-white h5">
                                        {% if show_eur %}
                                            ‚Ç¨{{ "{:,.0f}".format((analysis.sales_stats.price_stats.median / eur_rate)|int) }}
                                        {% else %}
                                            ‚Ç∏{{ "{:,}".format(analysis.sales_stats.price_stats.median|int) }}
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        {% else %}
                            <p class="text-muted">No sales data available</p>
                        {% endif %}
                    </div>

                    <!-- Rental Global Stats -->
                    <div class="col-md-6">
                        <h5 class="text-primary"><i class="fas fa-home me-1"></i>Rental Flats ({{ analysis.rental_stats.count }})</h5>
                        {% if analysis.rental_stats.count > 0 and rental_analysis and rental_analysis.current_market.global_stats %}
                            <div class="row mb-3">
                                <div class="col-6">
                                    <h6 class="text-muted">Min Yield</h6>
                                    <p class="text-white h5">
                                        {% if rental_analysis.current_market.global_stats.min_yield is not none %}
                                            {{ "{:.2f}%".format(rental_analysis.current_market.global_stats.min_yield * 100) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-6">
                                    <h6 class="text-muted">Max Yield</h6>
                                    <p class="text-white h5">
                                        {% if rental_analysis.current_market.global_stats.max_yield is not none %}
                                            {{ "{:.2f}%".format(rental_analysis.current_market.global_stats.max_yield * 100) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-6">
                                    <h6 class="text-muted">Mean Yield</h6>
                                    <p class="text-white h5">
                                        {% if rental_analysis.current_market.global_stats.mean_yield is not none %}
                                            {{ "{:.2f}%".format(rental_analysis.current_market.global_stats.mean_yield * 100) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-6">
                                    <h6 class="text-muted">Median Yield</h6>
                                    <p class="text-white h5">
                                        {% if rental_analysis.current_market.global_stats.median_yield is not none %}
                                            {{ "{:.2f}%".format(rental_analysis.current_market.global_stats.median_yield * 100) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        {% else %}
                            <p class="text-muted">No rental data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sales Statistics by Flat Type -->
<!-- DEBUG: flat_type_buckets = {{ flat_type_buckets | tojson }} -->
<!-- DEBUG: opportunities_by_flat_type = {{ opportunities_by_flat_type | tojson }} -->
{% if flat_type_buckets %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card stats-card">
            <div class="card-header" style="cursor: pointer;" onclick="toggleSection('sales-by-type')">
                <h4><i class="fas fa-chevron-down me-2" id="sales-by-type-icon"></i>Sales Statistics by Flat Type</h4>
                <p class="mb-0 text-white-50">Detailed analysis and opportunities by room count</p>
            </div>
            <div class="card-body collapse show" id="sales-by-type-content">
                {% for flat_type, bucket_stats in flat_type_buckets.items() %}
                {% if bucket_stats.count > 0 %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card" style="background: linear-gradient(135deg, var(--dark-card) 0%, #333 100%);">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-home me-2"></i>{{ flat_type }} ({{ bucket_stats.count }} flats)</h5>
                            </div>
                            <div class="card-body">
                                <!-- Price Statistics -->
                                <div class="row mb-3">
                                    <div class="col-6 col-md-3">
                                        <h6 class="text-muted">Min Price</h6>
                                        <p class="text-white h5">
                                            {% if show_eur %}
                                                ‚Ç¨{{ "{:,.0f}".format((bucket_stats.min|int / eur_rate)|int) }}
                                            {% else %}
                                                ‚Ç∏{{ "{:,}".format(bucket_stats.min|int) }}
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <h6 class="text-muted">Max Price</h6>
                                        <p class="text-white h5">
                                            {% if show_eur %}
                                                ‚Ç¨{{ "{:,.0f}".format((bucket_stats.max|int / eur_rate)|int) }}
                                            {% else %}
                                                ‚Ç∏{{ "{:,}".format(bucket_stats.max|int) }}
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <h6 class="text-muted">Mean Price</h6>
                                        <p class="text-white h5">
                                            {% if show_eur %}
                                                ‚Ç¨{{ "{:,.0f}".format((bucket_stats.mean|int / eur_rate)|int) }}
                                            {% else %}
                                                ‚Ç∏{{ "{:,}".format(bucket_stats.mean|int) }}
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <h6 class="text-muted">Median Price</h6>
                                        <p class="text-white h5">
                                            {% if show_eur %}
                                                ‚Ç¨{{ "{:,.0f}".format((bucket_stats.median|int / eur_rate)|int) }}
                                            {% else %}
                                                ‚Ç∏{{ "{:,}".format(bucket_stats.median|int) }}
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- Opportunities -->
                                {% if opportunities_by_flat_type[flat_type] %}
                                <div class="mt-3">
                                    <h6 class="text-success"><i class="fas fa-star me-1"></i>Good Opportunities (15%+ below median)</h6>
                                    <div class="row">
                                        {% for opp in opportunities_by_flat_type[flat_type] %}
                                        <div class="col-12 col-md-6 col-lg-4 mb-2">
                                            <div class="card border-success">
                                                <div class="card-body p-2">
                                                    <h6 class="card-title text-success">‚Ç∏{{ "{:,}".format(opp.price) }}</h6>
                                                    <p class="card-text small">
                                                        <strong>Discount:</strong> {{ "{:.1f}".format(opp.discount_percentage_vs_median) }}%<br>
                                                        {% set return_pct = ((opp.market_stats.median_price - opp.price) / opp.price) * 100 %}
                                                        <strong>Return:</strong> <span class="text-success">{{ "{:.2f}".format(return_pct) }}%</span><br>
                                                        <strong>Area:</strong> {{ opp.area }} m¬≤<br>
                                                        <strong>Floor:</strong> {{ opp.floor }}/{{ opp.total_floors }}<br>
                                                        <strong>Year:</strong> {{ opp.construction_year or 'N/A' }}
                                                    </p>
                                                    <div class="mt-2">
                                        <a href="{{ url_for('view_flat_details', flat_id=opp.flat_id) }}"
                                           class="btn btn-sm btn-success me-2">
                                            <i class="fas fa-info-circle me-1"></i>View Details
                                        </a>
                                                        <a href="https://krisha.kz/a/show/{{ opp.flat_id }}" 
                                                           target="_blank" 
                                                           class="btn btn-sm btn-outline-krisha">
                                                            <i class="fas fa-external-link-alt me-1"></i>View On Krisha
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% else %}
                                <div class="mt-3">
                                    <p class="text-muted"><i class="fas fa-info-circle me-1"></i>No opportunities found for this flat type</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>


<!-- Best Opportunities Section -->
{% if sales_opportunities or rental_opportunities %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header" style="cursor: pointer;" onclick="toggleSection('best-opportunities')">
                <h4><i class="fas fa-chevron-down me-2" id="best-opportunities-icon"></i>Best Opportunities</h4>
                <p class="mb-0 text-muted">Properties with 20% discount vs median price</p>
            </div>
            <div class="card-body collapse show" id="best-opportunities-content">
                <!-- Sales Opportunities -->
                {% if sales_opportunities %}
                <div class="mb-4">
                    <h5 class="text-success"><i class="fas fa-money-bill-wave me-1"></i>Sales Opportunities</h5>
                    {% for flat_type, opportunities in sales_opportunities.items() %}
                        {% if opportunities %}
                        <div class="mb-3">
                            <h6 class="text-muted">{{ flat_type }} ({{ opportunities|length }} opportunities)</h6>
                            <div class="row">
                                {% for opp in opportunities[:3] %}
                                <div class="col-12 col-md-4 mb-2">
                                    <div class="card border-success">
                                        <div class="card-body p-2">
                                            <h6 class="card-title text-success">‚Ç∏{{ "{:,}".format(opp.flat_info.price) }}</h6>
                                            <p class="card-text small">
                                                <strong>Discount:</strong> {{ "{:.1f}".format(opp.discount_percentage_vs_median) }}%<br>
                                                <strong>Area:</strong> {{ opp.flat_info.area }}m¬≤<br>
                                                <strong>Floor:</strong> {{ opp.flat_info.floor }}/{{ opp.flat_info.total_floors }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Rental Opportunities -->
                {% if rental_opportunities %}
                <div class="mb-4">
                    <h5 class="text-primary"><i class="fas fa-home me-1"></i>Rental Opportunities</h5>
                    {% for flat_type, opportunities in rental_opportunities.items() %}
                        {% if opportunities %}
                        <div class="mb-3">
                            <h6 class="text-muted">{{ flat_type }} ({{ opportunities|length }} opportunities)</h6>
                            <div class="row">
                                {% for opp in opportunities[:3] %}
                                <div class="col-12 col-md-4 mb-2">
                                    <div class="card border-primary">
                                        <div class="card-body p-2">
                                            <h6 class="card-title text-primary">‚Ç∏{{ "{:,}".format(opp.flat_info.price) }}</h6>
                                            <p class="card-text small">
                                                <strong>Yield:</strong> {{ "{:.1f}".format(opp.yield_percentage) }}%<br>
                                                <strong>Area:</strong> {{ opp.flat_info.area }}m¬≤<br>
                                                <strong>Floor:</strong> {{ opp.flat_info.floor }}/{{ opp.flat_info.total_floors }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Rental Analysis -->
{% if rental_analysis and rental_analysis.current_market.flat_type_buckets %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card stats-card">
            <div class="card-header" style="cursor: pointer;" onclick="toggleSection('rental-analysis')">
                <h4><i class="fas fa-chevron-down me-2" id="rental-analysis-icon"></i>Rental Analysis</h4>
                <p class="mb-0 text-white-50">Rental yield analysis by flat type (rent*12/median price)</p>
            </div>
            <div class="card-body collapse show" id="rental-analysis-content">
                <!-- Overall Summary -->
                <div class="row mb-4">
                    <div class="col-4">
                        <div class="text-center">
                            <h6 class="text-white">Median Yield</h6>
                            <h3 class="text-white">
                                {% if rental_analysis.current_market.global_stats.median_yield %}
                                    {{ "{:.2f}%".format(rental_analysis.current_market.global_stats.median_yield * 100) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </h3>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-center">
                            <h6 class="text-white">Mean Yield</h6>
                            <h3 class="text-white">
                                {% if rental_analysis.current_market.global_stats.mean_yield %}
                                    {{ "{:.2f}%".format(rental_analysis.current_market.global_stats.mean_yield * 100) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </h3>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-center">
                            <h6 class="text-white">Total Rentals</h6>
                            <h3 class="text-white">
                                {{ rental_analysis.current_market.global_stats.count }}
                            </h3>
                        </div>
                    </div>
                </div>
                
                <!-- Flat Type Details -->
                <div class="row">
                    {% for flat_type, rental_bucket_stats in rental_analysis.current_market.flat_type_buckets.items() %}
                    {% if rental_bucket_stats.count > 0 %}
                    <div class="col-12 col-md-6 col-lg-4 mb-3">
                        <div class="card h-100" style="background: linear-gradient(135deg, var(--dark-card) 0%, #333 100%);">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-home me-1"></i>{{ flat_type }}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12 mb-2">
                                        <small class="text-muted">Rental Flats: {{ rental_bucket_stats.count }}</small><br>
                                        <h5 class="text-white mt-2">
                                            Median Yield: {{ "{:.2f}%".format(rental_bucket_stats.median_yield * 100) }}
                                        </h5>
                                    </div>
                                </div>
                                <hr class="my-2">
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Min Yield</small><br>
                                        <small class="text-white">
                                            {{ "{:.2f}%".format(rental_bucket_stats.min_yield * 100) }}
                                        </small>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Max Yield</small><br>
                                        <small class="text-white">
                                            {{ "{:.2f}%".format(rental_bucket_stats.max_yield * 100) }}
                                        </small>
                                    </div>
                                </div>
                                <div class="row mt-1">
                                    <div class="col-12">
                                        <small class="text-muted">Mean Yield</small><br>
                                        <small class="text-white">
                                            {{ "{:.2f}%".format(rental_bucket_stats.mean_yield * 100) }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>

// Blacklist JK functionality
window.blacklistJK = function(jkName) {
    if (!confirm('Are you sure you want to blacklist "' + jkName + '"? This JK will be excluded from scraping and opportunities.')) {
        return;
    }
    fetch('/blacklist_jk/' + encodeURIComponent(jkName), { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/';
            } else {
                alert('Failed to blacklist: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => alert('Error: ' + err));
};

// Refresh Analysis functionality - Global functions
window.showRefreshConfirm = function() {
    console.log('üîç showRefreshConfirm function called');
    const complexName = '{{ complex_info.name | safe }}';
    const refreshBtn = document.getElementById('refreshAnalysisBtn');
    
    console.log('üîç complexName:', complexName);
    console.log('üîç refreshBtn:', refreshBtn);
    
    // Show confirmation dialog first
    console.log('üîç About to show confirm dialog...');
    const confirmed = confirm(`‚ö†Ô∏è Refresh Analysis Warning ‚ö†Ô∏è\n\nThis will fetch the latest data from Krisha.kz for ${complexName} and can take several minutes to complete.\n\nAre you sure you want to continue?`);
    
    console.log('üîç confirm result:', confirmed);
    
    if (confirmed) {
        console.log('üîç User confirmed, calling performRefreshAnalysis...');
        performRefreshAnalysis(complexName, refreshBtn);
    } else {
        console.log('üîç User cancelled');
    }
};

// Actual refresh function
window.performRefreshAnalysis = function(complexName, refreshBtn) {
    // Show loading state
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    
    // Show loading overlay
    showLoading(`Refreshing analysis for ${complexName}...`, 'Fetching latest data from Krisha.kz and updating analysis');
    
    // Make request to refresh endpoint
    const refreshUrl = `/refresh_analysis/{{ residential_complex_name | safe }}`;
    console.log('Calling refresh URL:', refreshUrl);
    
    fetch(refreshUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        console.log('Data success:', data.success);
        console.log('Data message:', data.message);
        
        // Hide loading overlay first
        hideLoading();
        
        // Reset button state
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh Analysis';
        
        if (data.success) {
            console.log('Success branch entered');
            
            // Show success message if elements exist
            try {
                const successMessage = document.getElementById('successMessage');
                const successMessageText = document.getElementById('successMessageText');
                console.log('Success message elements:', { successMessage, successMessageText });
                if (successMessage && successMessageText) {
                    successMessageText.textContent = data.message;
                    successMessage.style.display = 'block';
                    successMessage.classList.add('show');
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        successMessage.classList.remove('show');
                        setTimeout(() => {
                            successMessage.style.display = 'none';
                        }, 150);
                    }, 5000);
                }
            } catch (e) {
                console.error('Error showing success message:', e);
            }
            
            // Reload the page to show updated data after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            console.log('Error branch entered, throwing error');
            throw new Error(data.error || 'Refresh failed');
        }
    })
    .catch(error => {
        console.error('Error refreshing analysis:', error);
        console.error('Error stack:', error.stack);
        
        // Hide loading overlay
        hideLoading();
        
        // Reset button state
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh Analysis';
        
        // Show error message
        alert('Failed to refresh analysis. Please try again.');
    });
};

console.log('üîç Main script block loaded!');
console.log('üîç window.showRefreshConfirm:', typeof window.showRefreshConfirm);
console.log('üîç window.performRefreshAnalysis:', typeof window.performRefreshAnalysis);
</script>


{% endif %}


<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header" style="cursor: pointer;" onclick="toggleSection('summary-sales')">
                <h5><i class="fas fa-chevron-down me-2" id="summary-sales-icon"></i>Sales Flats ({{ sales_flats|length }})</h5>
            </div>
            <div class="card-body collapse show" id="summary-sales-content">
                {% if sales_flats %}
                    <div class="row">
                        <div class="col-6">
                            <div class="kpi-card">
                                <div class="kpi-value text-white">
                                    {% if show_eur %}
                                        ‚Ç¨{{ "{:,.0f}".format((sales_flats|map(attribute='price')|min) / eur_rate) }}
                                    {% else %}
                                        ‚Ç∏{{ "{:,}".format(sales_flats|map(attribute='price')|min) }}
                                    {% endif %}
                                </div>
                                <div class="kpi-label">Min Price</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi-card">
                                <div class="kpi-value text-white">
                                    {% if show_eur %}
                                        ‚Ç¨{{ "{:,.0f}".format((sales_flats|map(attribute='price')|max) / eur_rate) }}
                                    {% else %}
                                        ‚Ç∏{{ "{:,}".format(sales_flats|map(attribute='price')|max) }}
                                    {% endif %}
                                </div>
                                <div class="kpi-label">Max Price</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi-card">
                                <div class="kpi-value text-white">
                                    {% if show_eur %}
                                        ‚Ç¨{{ "{:,.0f}".format(((sales_flats|map(attribute='price')|sum) / sales_flats|length) / eur_rate) }}
                                    {% else %}
                                        ‚Ç∏{{ "{:,}".format(((sales_flats|map(attribute='price')|sum) / sales_flats|length)|int) }}
                                    {% endif %}
                                </div>
                                <div class="kpi-label">Avg Price</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi-card">
                                <div class="kpi-value text-white">
                                    {% if show_eur %}
                                        ‚Ç¨{{ "{:,.0f}".format(sales_median / eur_rate) }}
                                    {% else %}
                                        ‚Ç∏{{ "{:,}".format(sales_median|int) }}
                                    {% endif %}
                                </div>
                                <div class="kpi-label">Median Price</div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-muted">No sales flats found</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header" style="cursor: pointer;" onclick="toggleSection('summary-rental')">
                <h5><i class="fas fa-chevron-down me-2" id="summary-rental-icon"></i>Rental Flats ({{ rental_flats|length }})</h5>
            </div>
            <div class="card-body collapse show" id="summary-rental-content">
                {% if rental_flats %}
                    <div class="row">
                        <div class="col-6">
                            <div class="kpi-card">
                                <div class="kpi-value text-white">
                                    {% if show_eur %}
                                        ‚Ç¨{{ "{:,.0f}".format((rental_flats|map(attribute='price')|min) / eur_rate) }}
                                    {% else %}
                                        ‚Ç∏{{ "{:,}".format(rental_flats|map(attribute='price')|min) }}
                                    {% endif %}
                                </div>
                                <div class="kpi-label">Min Price</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi-card">
                                <div class="kpi-value text-white">
                                    {% if show_eur %}
                                        ‚Ç¨{{ "{:,.0f}".format((rental_flats|map(attribute='price')|max) / eur_rate) }}
                                    {% else %}
                                        ‚Ç∏{{ "{:,}".format(rental_flats|map(attribute='price')|max) }}
                                    {% endif %}
                                </div>
                                <div class="kpi-label">Max Price</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi-card">
                                <div class="kpi-value text-white">
                                    {% if show_eur %}
                                        ‚Ç¨{{ "{:,.0f}".format(((rental_flats|map(attribute='price')|sum) / rental_flats|length) / eur_rate) }}
                                    {% else %}
                                        ‚Ç∏{{ "{:,}".format(((rental_flats|map(attribute='price')|sum) / rental_flats|length)|int) }}
                                    {% endif %}
                                </div>
                                <div class="kpi-label">Avg Price</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi-card">
                                <div class="kpi-value text-white">
                                    {% set prices = rental_flats|map(attribute='price')|sort %}
                                    {% set n = prices|length %}
                                    {% set rental_median = (prices[n // 2 - 1] + prices[n // 2]) / 2 if n % 2 == 0 else prices[n // 2] %}
                                    {% if show_eur %}
                                        ‚Ç¨{{ "{:,.0f}".format(rental_median / eur_rate|int) }}
                                    {% else %}
                                        ‚Ç∏{{ "{:,}".format(rental_median|int) }}
                                    {% endif %}
                                </div>
                                <div class="kpi-label">Median Price</div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-muted">No rental flats found</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Sales Flats -->
{% if sales_flats %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header" style="cursor: pointer;" onclick="toggleSection('sales-flats')">
                <h4 class="mb-0">
                    <i class="fas fa-chevron-right me-2" id="sales-flats-icon"></i>Sales Flats ({{ sales_flats|length }})
                </h4>
            </div>
            <div class="card-body collapse" id="sales-flats-content">
                <div class="row">
                    {% for flat in sales_flats %}
                    <div class="col-12 col-md-6 col-lg-4 mb-3">
                        <div class="card h-100" style="background: linear-gradient(135deg, var(--dark-card) 0%, #333 100%);">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title text-success"><span class="price-kzt">‚Ç∏{{ "{:,}".format(flat.price) }}</span></h6>
                                    <span class="badge bg-success">Sale</span>
                                </div>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="fas fa-ruler-combined me-1"></i>{{ flat.area }} m¬≤
                                        {% if flat.floor %}<br><i class="fas fa-building me-1"></i>Floor {{ flat.floor }}{% endif %}
                                        {% if flat.construction_year %}<br><i class="fas fa-calendar me-1"></i>{{ flat.construction_year }}{% endif %}
                                        {% if flat.parking %}<br><i class="fas fa-car me-1"></i>{{ flat.parking }}{% endif %}
                                    </small>
                                </p>
                                <p class="card-text small">{{ flat.description[:100] }}{% if flat.description|length > 100 %}...{% endif %}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">{{ flat.query_date }}</small>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-warning toggle-favorite" 
                                                data-flat-id="{{ flat.flat_id }}" 
                                                data-flat-type="sale"
                                                data-price="{{ flat.price }}"
                                                data-area="{{ flat.area }}"
                                                data-residential-complex="{{ flat.residential_complex or '' }}"
                                                data-floor="{{ flat.floor or '' }}"
                                                data-total-floors="{{ flat.total_floors or '' }}"
                                                data-construction-year="{{ flat.construction_year or '' }}"
                                                data-parking="{{ flat.parking or '' }}"
                                                data-description="{{ flat.description }}"
                                                data-url="{{ flat.url }}">
                                            <i class="fas fa-heart"></i>
                                        </button>
                                        <a href="{{ url_for('view_flat_details', flat_id=flat.flat_id) }}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-calculator me-1"></i>Analyze
                                        </a>
                                        <a href="https://krisha.kz/a/show/{{ flat.flat_id }}" target="_blank" class="btn btn-sm btn-outline-krisha">
                                            <i class="fas fa-external-link-alt me-1"></i>View on Krisha
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Rental Flats -->
{% if rental_flats %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header" style="cursor: pointer;" onclick="toggleSection('rental-flats')">
                <h4 class="mb-0">
                    <i class="fas fa-chevron-right me-2" id="rental-flats-icon"></i>Rental Flats ({{ rental_flats|length }})
                </h4>
            </div>
            <div class="card-body collapse" id="rental-flats-content">
                <div class="row">
                    {% for flat in rental_flats %}
                    <div class="col-12 col-md-6 col-lg-4 mb-3">
                        <div class="card h-100" style="background: linear-gradient(135deg, var(--dark-card) 0%, #333 100%);">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title text-primary"><span class="price-kzt">‚Ç∏{{ "{:,}".format(flat.price) }}</span></h6>
                                    <span class="badge bg-primary">Rental</span>
                                </div>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="fas fa-ruler-combined me-1"></i>{{ flat.area }} m¬≤
                                        {% if flat.floor %}<br><i class="fas fa-building me-1"></i>Floor {{ flat.floor }}{% endif %}
                                        {% if flat.construction_year %}<br><i class="fas fa-calendar me-1"></i>{{ flat.construction_year }}{% endif %}
                                        {% if flat.parking %}<br><i class="fas fa-car me-1"></i>{{ flat.parking }}{% endif %}
                                    </small>
                                </p>
                                <p class="card-text small">{{ flat.description[:100] }}{% if flat.description|length > 100 %}...{% endif %}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">{{ flat.query_date }}</small>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-warning toggle-favorite" 
                                                data-flat-id="{{ flat.flat_id }}" 
                                                data-flat-type="rental"
                                                data-price="{{ flat.price }}"
                                                data-area="{{ flat.area }}"
                                                data-residential-complex="{{ flat.residential_complex or '' }}"
                                                data-floor="{{ flat.floor or '' }}"
                                                data-total-floors="{{ flat.total_floors or '' }}"
                                                data-construction-year="{{ flat.construction_year or '' }}"
                                                data-parking="{{ flat.parking or '' }}"
                                                data-description="{{ flat.description }}"
                                                data-url="{{ flat.url }}">
                                            <i class="fas fa-heart"></i>
                                        </button>
                                        <a href="https://krisha.kz/a/show/{{ flat.flat_id }}" target="_blank" class="btn btn-sm btn-outline-krisha">
                                            <i class="fas fa-external-link-alt me-1"></i>View on Krisha
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
console.log('üîç extra_js script block loaded!');
console.log('üîç About to define window functions...');

// Toggle section functionality
function toggleSection(sectionId) {
    const content = document.getElementById(sectionId + '-content');
    const icon = document.getElementById(sectionId + '-icon');
    
    // Toggle the show class
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    } else {
        content.classList.add('show');
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
    }
}
    
// Favorite functionality is now handled by the optimized favorites manager
// No additional JavaScript needed here
    
    console.log('üîç extra_js script block completed!');
    console.log('üîç window.showRefreshConfirm:', typeof window.showRefreshConfirm);
    console.log('üîç window.performRefreshAnalysis:', typeof window.performRefreshAnalysis);

// Handle area_tolerance and discount_percentage input changes
document.addEventListener('DOMContentLoaded', function() {
    const areaToleranceInput = document.getElementById('area_tolerance');
    const discountPercentageInput = document.getElementById('discount_percentage');
    
    function updateURL() {
        const areaTolerance = areaToleranceInput.value;
        const discountPercentage = discountPercentageInput.value;
        
        // Build new URL with updated parameters
        const url = new URL(window.location.href);
        url.searchParams.set('area_tolerance', areaTolerance);
        url.searchParams.set('discount_percentage', discountPercentage);
        
        // Reload page with new parameters
        window.location.href = url.toString();
    }
    
    // Add change event listeners - update on blur (when user finishes editing)
    areaToleranceInput.addEventListener('change', function() {
        const value = parseFloat(this.value);
        if (value < 1) this.value = 1;
        if (value > 100) this.value = 100;
        updateURL();
    });
    
    discountPercentageInput.addEventListener('change', function() {
        const value = parseFloat(this.value);
        if (value < 1) this.value = 1;
        if (value > 100) this.value = 100;
        updateURL();
    });
});
</script>
{% endblock %} 