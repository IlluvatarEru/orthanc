{% extends "base.html" %}

{% block title %}♖ Favorites - Orthanc Capital{% endblock %}

{% block content %}
<!-- Favorites Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h2 class="mb-1"><i class="fas fa-heart me-2"></i>My Favorites</h2>
                <p class="mb-0 text-muted">Your saved flats for quick access and analysis</p>
            </div>
        </div>
    </div>
</div>

<!-- Favorites List -->
{% if favorites %}
<div class="row">
    {% for flat in favorites %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100" style="background: linear-gradient(135deg, var(--dark-card) 0%, #333 100%);">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title">
                        <span class="{% if flat.flat_type == 'sale' %}text-success{% else %}text-primary{% endif %}">
                            <span class="price-kzt">₸{{ "{:,}".format(flat.price) }}</span>
                        </span>
                    </h6>
                    <div class="d-flex gap-1">
                        <span class="badge {% if flat.flat_type == 'sale' %}bg-success{% else %}bg-primary{% endif %}">
                            {{ flat.flat_type|title }}
                        </span>
                        <button class="btn btn-sm btn-outline-danger remove-favorite" 
                                data-flat-id="{{ flat.flat_id }}" 
                                data-flat-type="{{ flat.flat_type }}">
                            <i class="fas fa-heart-broken"></i>
                        </button>
                    </div>
                </div>
                
                <p class="card-text">
                    <small class="text-muted">
                        <i class="fas fa-ruler-combined me-1"></i>{{ flat.area }} m²
                        {% if flat.floor %}<br><i class="fas fa-building me-1"></i>Floor {{ flat.floor }}{% endif %}
                        {% if flat.construction_year %}<br><i class="fas fa-calendar me-1"></i>{{ flat.construction_year }}{% endif %}
                        {% if flat.parking %}<br><i class="fas fa-car me-1"></i>{{ flat.parking }}{% endif %}
                        {% if flat.residential_complex %}<br><i class="fas fa-home me-1"></i>{{ flat.residential_complex }}{% endif %}
                    </small>
                </p>
                
                <p class="card-text small">{{ flat.description[:100] }}{% if flat.description|length > 100 %}...{% endif %}</p>
                
                {% if flat.notes %}
                <div class="alert alert-info py-2 mb-2">
                    <small><i class="fas fa-sticky-note me-1"></i>{{ flat.notes }}</small>
                </div>
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">Added: {{ flat.added_at[:10] }}</small>
                    <div class="btn-group" role="group">
                        {% if flat.flat_type == 'sale' %}
                        <a href="{{ url_for('estimate_flat') }}?flat_id={{ flat.flat_id }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-calculator me-1"></i>Analyze
                        </a>
                        {% endif %}
                        <a href="{{ flat.url }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-external-link-alt me-1"></i>View on Krisha
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Statistics -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Favorites Summary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-primary">{{ favorites|length }}</h4>
                            <small class="text-muted">Total Favorites</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success">{{ favorites|selectattr('flat_type', 'equalto', 'sale')|list|length }}</h4>
                            <small class="text-muted">Sales Flats</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-primary">{{ favorites|selectattr('flat_type', 'equalto', 'rental')|list|length }}</h4>
                            <small class="text-muted">Rental Flats</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning">{{ favorites|selectattr('notes')|list|length }}</h4>
                            <small class="text-muted">With Notes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Empty State -->
<div class="row">
    <div class="col-12">
        <div class="card text-center">
            <div class="card-body py-5">
                <i class="fas fa-heart text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
                <h4 class="mt-3 text-muted">No Favorites Yet</h4>
                <p class="text-muted">Start adding flats to your favorites to see them here.</p>
                <a href="{{ url_for('search_jk') }}" class="btn btn-primary">
                    <i class="fas fa-search me-2"></i>Search for Flats
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Remove from favorites functionality
    const removeButtons = document.querySelectorAll('.remove-favorite');
    
    removeButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const flatId = this.getAttribute('data-flat-id');
            const flatType = this.getAttribute('data-flat-type');
            
            if (confirm('Are you sure you want to remove this flat from favorites?')) {
                fetch('/api/favorites/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        flat_id: flatId,
                        flat_type: flatType
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the card from the DOM
                        this.closest('.col-md-6').remove();
                        
                        // Show success message
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-success alert-dismissible fade show';
                        alert.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>${data.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row'));
                        
                        // Reload page if no favorites left
                        if (document.querySelectorAll('.remove-favorite').length === 0) {
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error removing from favorites');
                });
            }
        });
    });
});
</script>
{% endblock %} 